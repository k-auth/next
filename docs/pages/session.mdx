# 세션 관리

로그인 후 사용자 세션을 확인하고 관리하는 방법입니다.

## 서버에서 세션 확인

### Server Component

```tsx filename="app/page.tsx"
import { auth } from '@/auth';

export default async function Page() {
  const session = await auth();

  if (!session) {
    return <p>로그인이 필요합니다</p>;
  }

  return <p>안녕하세요, {session.user?.name}님!</p>;
}
```

### Server Action

```typescript filename="app/actions.ts"
'use server';

import { auth } from '@/auth';

export async function getProfile() {
  const session = await auth();

  if (!session) {
    throw new Error('Unauthorized');
  }

  return session.user;
}
```

### API Route

```typescript filename="app/api/me/route.ts"
import { auth } from '@/auth';
import { NextResponse } from 'next/server';

export async function GET() {
  const session = await auth();

  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  return NextResponse.json(session.user);
}
```

## 클라이언트에서 세션 확인

클라이언트 컴포넌트에서 세션을 사용하려면 `SessionProvider`가 필요합니다.

### 1. SessionProvider 설정

```tsx filename="app/providers.tsx"
'use client';

import { SessionProvider } from 'next-auth/react';

export function Providers({ children }: { children: React.ReactNode }) {
  return <SessionProvider>{children}</SessionProvider>;
}
```

```tsx filename="app/layout.tsx"
import { Providers } from './providers';

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <Providers>{children}</Providers>
      </body>
    </html>
  );
}
```

### 2. useSession 사용

```tsx filename="components/UserMenu.tsx"
'use client';

import { useSession, signOut } from 'next-auth/react';

export function UserMenu() {
  const { data: session, status } = useSession();

  if (status === 'loading') {
    return <p>로딩중...</p>;
  }

  if (!session) {
    return <a href="/login">로그인</a>;
  }

  return (
    <div>
      <img src={session.user?.image} alt="프로필" />
      <p>{session.user?.name}</p>
      <button onClick={() => signOut()}>로그아웃</button>
    </div>
  );
}
```

## 세션 데이터

기본 세션에는 다음 정보가 포함됩니다:

```typescript
interface Session {
  user?: {
    name?: string | null;
    email?: string | null;
    image?: string | null;
  };
  expires: string;
}
```

### 세션에 추가 정보 포함

```typescript filename="auth.ts"
KAuth({
  kakao: { ... },
  nextAuthConfig: {
    callbacks: {
      session({ session, token }) {
        // 사용자 ID 추가
        session.user.id = token.sub!;
        // provider 정보 추가
        session.user.provider = token.provider;
        return session;
      },
      jwt({ token, account }) {
        if (account) {
          token.provider = account.provider;
        }
        return token;
      },
    },
  },
});
```

### TypeScript 타입 확장

```typescript filename="types/next-auth.d.ts"
import 'next-auth';

declare module 'next-auth' {
  interface Session {
    user: {
      id: string;
      provider?: string;
    } & DefaultSession['user'];
  }
}
```

## 로그아웃

### 서버에서

```typescript
import { signOut } from '@/auth';

// Server Action 또는 form action에서
await signOut();

// 특정 URL로 리다이렉트
await signOut({ redirectTo: '/' });
```

### 클라이언트에서

```tsx
'use client';

import { signOut } from 'next-auth/react';

<button onClick={() => signOut()}>로그아웃</button>

// 특정 URL로 리다이렉트
<button onClick={() => signOut({ callbackUrl: '/' })}>로그아웃</button>
```
