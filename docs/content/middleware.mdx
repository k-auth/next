# 미들웨어

Next.js 미들웨어를 사용해 페이지를 보호하는 방법입니다.

## 기본 설정

```typescript filename="middleware.ts"
import { auth } from '@/auth';

export default auth((req) => {
  const isLoggedIn = !!req.auth;
  const isOnLoginPage = req.nextUrl.pathname === '/login';

  // 로그인 페이지는 누구나 접근 가능
  if (isOnLoginPage) {
    return;
  }

  // 그 외 페이지는 로그인 필요
  if (!isLoggedIn) {
    return Response.redirect(new URL('/login', req.nextUrl));
  }
});

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
};
```

## 특정 경로만 보호

```typescript filename="middleware.ts"
import { auth } from '@/auth';

const protectedRoutes = ['/dashboard', '/settings', '/profile'];

export default auth((req) => {
  const isProtected = protectedRoutes.some((route) =>
    req.nextUrl.pathname.startsWith(route)
  );

  if (isProtected && !req.auth) {
    return Response.redirect(new URL('/login', req.nextUrl));
  }
});

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
};
```

## 역할 기반 접근 제어

```typescript filename="middleware.ts"
import { auth } from '@/auth';

export default auth((req) => {
  const { pathname } = req.nextUrl;

  // 관리자 페이지
  if (pathname.startsWith('/admin')) {
    if (!req.auth) {
      return Response.redirect(new URL('/login', req.nextUrl));
    }

    // 관리자 권한 확인 (세션에 role이 있다고 가정)
    if (req.auth.user?.role !== 'admin') {
      return Response.redirect(new URL('/unauthorized', req.nextUrl));
    }
  }
});
```

## 로그인 후 원래 페이지로 돌아가기

```typescript filename="middleware.ts"
import { auth } from '@/auth';

export default auth((req) => {
  if (!req.auth && req.nextUrl.pathname !== '/login') {
    const loginUrl = new URL('/login', req.nextUrl);
    // 원래 가려던 URL을 쿼리 파라미터로 저장
    loginUrl.searchParams.set('callbackUrl', req.nextUrl.pathname);
    return Response.redirect(loginUrl);
  }
});
```

로그인 페이지에서 `callbackUrl`로 리다이렉트:

```tsx filename="app/login/page.tsx"
import { signIn } from '@/auth';

export default function LoginPage({
  searchParams,
}: {
  searchParams: { callbackUrl?: string };
}) {
  const callbackUrl = searchParams.callbackUrl || '/';

  return (
    <Button.Kakao
      onClick={() => signIn('kakao', { redirectTo: callbackUrl })}
    />
  );
}
```

## API 라우트 보호

API 라우트는 미들웨어 대신 직접 세션을 확인합니다:

```typescript filename="app/api/protected/route.ts"
import { auth } from '@/auth';
import { NextResponse } from 'next/server';

export async function GET() {
  const session = await auth();

  if (!session) {
    return NextResponse.json(
      { error: '로그인이 필요합니다' },
      { status: 401 }
    );
  }

  return NextResponse.json({ data: 'protected data' });
}
```

## Matcher 패턴

```typescript
export const config = {
  matcher: [
    // 모든 경로 (정적 파일 제외)
    '/((?!api|_next/static|_next/image|favicon.ico).*)',

    // 특정 경로만
    '/dashboard/:path*',
    '/settings/:path*',

    // API 라우트 포함
    '/api/protected/:path*',
  ],
};
```

import { Callout } from 'nextra/components'

<Callout type="info">
미들웨어는 Edge Runtime에서 실행됩니다. 데이터베이스 직접 연결 등 일부 기능이 제한될 수 있습니다.
</Callout>
