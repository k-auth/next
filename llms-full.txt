# K-Auth

> 한국형 소셜 로그인 라이브러리 for Next.js

K-Auth는 카카오, 네이버 로그인을 Next.js에서 가장 쉽게 구현할 수 있는 라이브러리입니다.
next-auth(Auth.js)를 래핑하여 한국 개발자를 위한 편의 기능을 제공합니다.

- GitHub: https://github.com/relkimm/k-auth
- npm: https://www.npmjs.com/package/@relkimm/k-auth

---

# 주요 기능

- 카카오/네이버 OAuth provider 내장 (next-auth 공식 미지원)
- 공식 디자인 가이드를 준수한 로그인 버튼 컴포넌트
- 한국어 에러 메시지
- `collectPhone: true` 같은 직관적인 옵션으로 scope 자동 설정
- next-auth 완벽 호환 (구글, 애플, GitHub 등 함께 사용 가능)

---

# 설치

```bash
npm install @relkimm/k-auth
```

```bash
yarn add @relkimm/k-auth
```

```bash
pnpm add @relkimm/k-auth
```

## 함께 설치되는 패키지

K-Auth를 설치하면 다음 패키지들이 자동으로 함께 설치됩니다:

- `next-auth` - 인증 코어
- `clsx` - 클래스명 유틸리티
- `tailwind-merge` - Tailwind 클래스 병합

## Peer Dependencies

다음 패키지들은 프로젝트에 이미 설치되어 있어야 합니다:

- `react` >= 18.0.0
- `react-dom` >= 18.0.0

## 요구사항

- Next.js 14+
- React 18+

---

# 빠른 시작

5분 안에 카카오/네이버 로그인을 구현합니다.

## 1. 환경 변수 설정

프로젝트 루트에 `.env.local` 파일을 생성합니다:

```env
# 카카오
KAKAO_CLIENT_ID=your_kakao_rest_api_key
KAKAO_CLIENT_SECRET=your_kakao_client_secret

# 네이버
NAVER_CLIENT_ID=your_naver_client_id
NAVER_CLIENT_SECRET=your_naver_client_secret

# NextAuth 필수
AUTH_SECRET=your_secret_key
```

`AUTH_SECRET`은 다음 명령어로 생성할 수 있습니다:

```bash
openssl rand -base64 32
```

## 2. auth.ts 생성

프로젝트 루트에 `auth.ts` 파일을 생성합니다:

```typescript
// auth.ts
import { KAuth } from '@relkimm/k-auth';

export const { handlers, auth, signIn, signOut } = KAuth({
  kakao: {
    clientId: process.env.KAKAO_CLIENT_ID!,
    clientSecret: process.env.KAKAO_CLIENT_SECRET!,
  },
  naver: {
    clientId: process.env.NAVER_CLIENT_ID!,
    clientSecret: process.env.NAVER_CLIENT_SECRET!,
  },
});
```

## 3. API 라우트 설정

`app/api/auth/[...nextauth]/route.ts` 파일을 생성합니다:

```typescript
// app/api/auth/[...nextauth]/route.ts
import { handlers } from '@/auth';

export const { GET, POST } = handlers;
```

## 4. 로그인 페이지 만들기

```tsx
// app/login/page.tsx
import { Button } from '@relkimm/k-auth/ui';
import { signIn } from '@/auth';

export default function LoginPage() {
  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="w-full max-w-sm space-y-4">
        <h1 className="text-2xl font-bold text-center">로그인</h1>

        <Button.Group>
          <Button.Kakao onClick={() => signIn('kakao')} />
          <Button.Naver onClick={() => signIn('naver')} />
        </Button.Group>
      </div>
    </div>
  );
}
```

## 5. 세션 확인

로그인 후 세션을 확인하려면:

```tsx
// app/page.tsx
import { auth } from '@/auth';

export default async function Home() {
  const session = await auth();

  if (!session) {
    return <a href="/login">로그인하세요</a>;
  }

  return (
    <div>
      <p>안녕하세요, {session.user?.name}님!</p>
      <img src={session.user?.image} alt="프로필" />
    </div>
  );
}
```

## 6. 개발 서버 실행

```bash
npm run dev
```

http://localhost:3000/login 에 접속하면 로그인 버튼이 보입니다.

---

# 옵션

K-Auth provider의 모든 설정 옵션입니다.

## 카카오 옵션

```typescript
KAuth({
  kakao: {
    // 필수
    clientId: string,
    clientSecret: string,

    // 추가 정보 수집 (선택)
    collectPhone: boolean,    // 전화번호
    collectBirth: boolean,    // 생년월일
    collectGender: boolean,   // 성별
    collectAgeRange: boolean, // 연령대
  },
});
```

### 카카오 옵션 상세

| 옵션 | 타입 | 기본값 | 설명 |
|------|------|--------|------|
| `clientId` | `string` | - | 카카오 REST API 키 **(필수)** |
| `clientSecret` | `string` | - | 카카오 Client Secret **(필수)** |
| `collectPhone` | `boolean` | `false` | 전화번호 수집 |
| `collectBirth` | `boolean` | `false` | 생년월일 수집 |
| `collectGender` | `boolean` | `false` | 성별 수집 |
| `collectAgeRange` | `boolean` | `false` | 연령대 수집 |

### 카카오 추가 정보 수집 예시

```typescript
KAuth({
  kakao: {
    clientId: process.env.KAKAO_CLIENT_ID!,
    clientSecret: process.env.KAKAO_CLIENT_SECRET!,
    collectPhone: true,   // scope에 phone_number 자동 추가
    collectBirth: true,   // scope에 birthday 자동 추가
  },
});
```

> 추가 정보를 수집하려면 카카오 개발자센터에서 해당 동의 항목을 먼저 활성화해야 합니다.

## 네이버 옵션

```typescript
KAuth({
  naver: {
    // 필수
    clientId: string,
    clientSecret: string,

    // 추가 정보 수집 (선택)
    collectPhone: boolean,  // 전화번호
    collectBirth: boolean,  // 생년월일
    collectGender: boolean, // 성별
    collectName: boolean,   // 실명
  },
});
```

### 네이버 옵션 상세

| 옵션 | 타입 | 기본값 | 설명 |
|------|------|--------|------|
| `clientId` | `string` | - | 네이버 Client ID **(필수)** |
| `clientSecret` | `string` | - | 네이버 Client Secret **(필수)** |
| `collectPhone` | `boolean` | `false` | 전화번호 수집 |
| `collectBirth` | `boolean` | `false` | 생년월일 수집 |
| `collectGender` | `boolean` | `false` | 성별 수집 |
| `collectName` | `boolean` | `false` | 실명 수집 |

네이버는 애플리케이션 등록 시 **제공 정보 선택**에서 미리 체크해야 합니다.
K-Auth 옵션은 해당 정보를 프로필에서 가져오도록 설정합니다.

## 전체 설정 예시

```typescript
import { KAuth } from '@relkimm/k-auth';

export const { handlers, auth, signIn, signOut } = KAuth({
  kakao: {
    clientId: process.env.KAKAO_CLIENT_ID!,
    clientSecret: process.env.KAKAO_CLIENT_SECRET!,
    collectPhone: true,
    collectBirth: true,
    collectGender: true,
  },
  naver: {
    clientId: process.env.NAVER_CLIENT_ID!,
    clientSecret: process.env.NAVER_CLIENT_SECRET!,
    collectName: true,
    collectPhone: true,
  },
});
```

---

# Providers

K-Auth에서 지원하는 로그인 provider들입니다.

## 내장 Provider

K-Auth에 기본 내장된 provider입니다. 별도 import 없이 바로 사용할 수 있습니다.

### 카카오

```typescript
KAuth({
  kakao: {
    clientId: process.env.KAKAO_CLIENT_ID!,
    clientSecret: process.env.KAKAO_CLIENT_SECRET!,
  },
});
```

**버튼:**
```tsx
<Button.Kakao onClick={() => signIn('kakao')} />
```

**추가 정보 수집:**
```typescript
kakao: {
  clientId: '...',
  clientSecret: '...',
  collectPhone: true,    // 전화번호
  collectBirth: true,    // 생년월일
  collectGender: true,   // 성별
  collectAgeRange: true, // 연령대
}
```

### 네이버

```typescript
KAuth({
  naver: {
    clientId: process.env.NAVER_CLIENT_ID!,
    clientSecret: process.env.NAVER_CLIENT_SECRET!,
  },
});
```

**버튼:**
```tsx
<Button.Naver onClick={() => signIn('naver')} />
```

**추가 정보 수집:**
```typescript
naver: {
  clientId: '...',
  clientSecret: '...',
  collectPhone: true,  // 전화번호
  collectBirth: true,  // 생년월일
  collectGender: true, // 성별
  collectName: true,   // 실명
}
```

## 외부 Provider

next-auth의 공식 provider를 `nextAuthConfig`로 추가합니다.

### 구글

```typescript
import Google from 'next-auth/providers/google';

KAuth({
  kakao: { ... },
  nextAuthConfig: {
    providers: [
      Google({
        clientId: process.env.GOOGLE_CLIENT_ID!,
        clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      }),
    ],
  },
});
```

**버튼:**
```tsx
<Button.Google onClick={() => signIn('google')} />
```

**콘솔 설정:**
1. [Google Cloud Console](https://console.cloud.google.com) 접속
2. OAuth 동의 화면 설정
3. 사용자 인증 정보 → OAuth 2.0 클라이언트 ID 생성
4. Redirect URI: `http://localhost:3000/api/auth/callback/google`

### 애플

```typescript
import Apple from 'next-auth/providers/apple';

KAuth({
  kakao: { ... },
  nextAuthConfig: {
    providers: [
      Apple({
        clientId: process.env.APPLE_CLIENT_ID!,
        clientSecret: process.env.APPLE_CLIENT_SECRET!,
      }),
    ],
  },
});
```

**버튼:**
```tsx
<Button.Apple onClick={() => signIn('apple')} />
```

> 애플 로그인은 HTTPS 필수입니다. localhost에서 테스트가 어렵습니다.

**콘솔 설정:**
1. [Apple Developer](https://developer.apple.com) 접속
2. App ID 생성 (Sign in with Apple 활성화)
3. Services ID 생성
4. Key 생성 후 Client Secret 생성

자세한 내용은 [Auth.js Apple 문서](https://authjs.dev/getting-started/providers/apple) 참고

### GitHub

```typescript
import GitHub from 'next-auth/providers/github';

KAuth({
  kakao: { ... },
  nextAuthConfig: {
    providers: [
      GitHub({
        clientId: process.env.GITHUB_CLIENT_ID!,
        clientSecret: process.env.GITHUB_CLIENT_SECRET!,
      }),
    ],
  },
});
```

**콘솔 설정:**
1. [GitHub Developer Settings](https://github.com/settings/developers) 접속
2. OAuth Apps → New OAuth App
3. Authorization callback URL: `http://localhost:3000/api/auth/callback/github`

## 전체 예시

```typescript
import { KAuth } from '@relkimm/k-auth';
import Google from 'next-auth/providers/google';
import Apple from 'next-auth/providers/apple';

export const { handlers, auth, signIn, signOut } = KAuth({
  // 한국 서비스 (K-Auth 내장)
  kakao: {
    clientId: process.env.KAKAO_CLIENT_ID!,
    clientSecret: process.env.KAKAO_CLIENT_SECRET!,
    collectPhone: true,
  },
  naver: {
    clientId: process.env.NAVER_CLIENT_ID!,
    clientSecret: process.env.NAVER_CLIENT_SECRET!,
  },
  // 글로벌 서비스 (next-auth)
  nextAuthConfig: {
    providers: [
      Google({
        clientId: process.env.GOOGLE_CLIENT_ID!,
        clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      }),
      Apple({
        clientId: process.env.APPLE_CLIENT_ID!,
        clientSecret: process.env.APPLE_CLIENT_SECRET!,
      }),
    ],
  },
});
```

```tsx
<Button.Group>
  <Button.Kakao onClick={() => signIn('kakao')} />
  <Button.Naver onClick={() => signIn('naver')} />
  <Button.Google onClick={() => signIn('google')} />
  <Button.Apple onClick={() => signIn('apple')} />
</Button.Group>
```

---

# 버튼 컴포넌트

K-Auth는 각 서비스의 공식 디자인 가이드라인을 준수한 버튼을 제공합니다.

## 기본 사용법

```tsx
import { Button } from '@relkimm/k-auth/ui';

<Button.Kakao />
<Button.Naver />
<Button.Google />
<Button.Apple />
```

## 크기

`size` prop으로 버튼 크기를 조절합니다.

```tsx
<Button.Kakao size="sm" />      // 작게
<Button.Kakao size="default" /> // 기본
<Button.Kakao size="lg" />      // 크게
<Button.Kakao size="icon" />    // 아이콘만
```

## 버튼 그룹

`Button.Group`으로 여러 버튼을 묶을 수 있습니다.

```tsx
// 세로 배치 (기본)
<Button.Group>
  <Button.Kakao />
  <Button.Naver />
</Button.Group>

// 가로 배치
<Button.Group direction="row">
  <Button.Kakao size="icon" />
  <Button.Naver size="icon" />
</Button.Group>

// 간격 조절
<Button.Group gap="lg">
  <Button.Kakao />
  <Button.Naver />
</Button.Group>
```

### ButtonGroup Props

| Prop | 타입 | 기본값 | 설명 |
|------|------|--------|------|
| `direction` | `'column' \| 'row'` | `'column'` | 배치 방향 |
| `gap` | `'sm' \| 'md' \| 'lg'` | `'md'` | 버튼 간격 |

## 스타일 커스텀

Tailwind CSS 클래스를 추가할 수 있습니다.

```tsx
<Button.Kakao className="w-full" />
<Button.Kakao className="rounded-xl shadow-lg" />
```

## onClick 핸들러

```tsx
import { signIn } from '@/auth';

<Button.Kakao onClick={() => signIn('kakao')} />
<Button.Naver onClick={() => signIn('naver')} />
```

## 디자인 가이드라인

K-Auth 버튼은 각 서비스의 공식 가이드라인을 따릅니다:

- [카카오 로그인 디자인 가이드](https://developers.kakao.com/docs/latest/ko/kakaologin/design-guide)
- [네이버 로그인 디자인 가이드](https://developers.naver.com/docs/login/bi/)

---

# 세션 관리

로그인 후 사용자 세션을 확인하고 관리하는 방법입니다.

## 서버에서 세션 확인

### Server Component

```tsx
// app/page.tsx
import { auth } from '@/auth';

export default async function Page() {
  const session = await auth();

  if (!session) {
    return <p>로그인이 필요합니다</p>;
  }

  return <p>안녕하세요, {session.user?.name}님!</p>;
}
```

### Server Action

```typescript
// app/actions.ts
'use server';

import { auth } from '@/auth';

export async function getProfile() {
  const session = await auth();

  if (!session) {
    throw new Error('Unauthorized');
  }

  return session.user;
}
```

### API Route

```typescript
// app/api/me/route.ts
import { auth } from '@/auth';
import { NextResponse } from 'next/server';

export async function GET() {
  const session = await auth();

  if (!session) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  return NextResponse.json(session.user);
}
```

## 클라이언트에서 세션 확인

클라이언트 컴포넌트에서 세션을 사용하려면 `SessionProvider`가 필요합니다.

### 1. SessionProvider 설정

```tsx
// app/providers.tsx
'use client';

import { SessionProvider } from 'next-auth/react';

export function Providers({ children }: { children: React.ReactNode }) {
  return <SessionProvider>{children}</SessionProvider>;
}
```

```tsx
// app/layout.tsx
import { Providers } from './providers';

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <Providers>{children}</Providers>
      </body>
    </html>
  );
}
```

### 2. useSession 사용

```tsx
// components/UserMenu.tsx
'use client';

import { useSession, signOut } from 'next-auth/react';

export function UserMenu() {
  const { data: session, status } = useSession();

  if (status === 'loading') {
    return <p>로딩중...</p>;
  }

  if (!session) {
    return <a href="/login">로그인</a>;
  }

  return (
    <div>
      <img src={session.user?.image} alt="프로필" />
      <p>{session.user?.name}</p>
      <button onClick={() => signOut()}>로그아웃</button>
    </div>
  );
}
```

## 세션 데이터

기본 세션에는 다음 정보가 포함됩니다:

```typescript
interface Session {
  user?: {
    name?: string | null;
    email?: string | null;
    image?: string | null;
  };
  expires: string;
}
```

### 세션에 추가 정보 포함

```typescript
// auth.ts
KAuth({
  kakao: { ... },
  nextAuthConfig: {
    callbacks: {
      session({ session, token }) {
        // 사용자 ID 추가
        session.user.id = token.sub!;
        // provider 정보 추가
        session.user.provider = token.provider;
        return session;
      },
      jwt({ token, account }) {
        if (account) {
          token.provider = account.provider;
        }
        return token;
      },
    },
  },
});
```

### TypeScript 타입 확장

```typescript
// types/next-auth.d.ts
import 'next-auth';

declare module 'next-auth' {
  interface Session {
    user: {
      id: string;
      provider?: string;
    } & DefaultSession['user'];
  }
}
```

## 로그아웃

### 서버에서

```typescript
import { signOut } from '@/auth';

// Server Action 또는 form action에서
await signOut();

// 특정 URL로 리다이렉트
await signOut({ redirectTo: '/' });
```

### 클라이언트에서

```tsx
'use client';

import { signOut } from 'next-auth/react';

<button onClick={() => signOut()}>로그아웃</button>

// 특정 URL로 리다이렉트
<button onClick={() => signOut({ callbackUrl: '/' })}>로그아웃</button>
```

---

# 미들웨어

Next.js 미들웨어를 사용해 페이지를 보호하는 방법입니다.

## 기본 설정

```typescript
// middleware.ts
import { auth } from '@/auth';

export default auth((req) => {
  const isLoggedIn = !!req.auth;
  const isOnLoginPage = req.nextUrl.pathname === '/login';

  // 로그인 페이지는 누구나 접근 가능
  if (isOnLoginPage) {
    return;
  }

  // 그 외 페이지는 로그인 필요
  if (!isLoggedIn) {
    return Response.redirect(new URL('/login', req.nextUrl));
  }
});

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
};
```

## 특정 경로만 보호

```typescript
// middleware.ts
import { auth } from '@/auth';

const protectedRoutes = ['/dashboard', '/settings', '/profile'];

export default auth((req) => {
  const isProtected = protectedRoutes.some((route) =>
    req.nextUrl.pathname.startsWith(route)
  );

  if (isProtected && !req.auth) {
    return Response.redirect(new URL('/login', req.nextUrl));
  }
});

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
};
```

## 역할 기반 접근 제어

```typescript
// middleware.ts
import { auth } from '@/auth';

export default auth((req) => {
  const { pathname } = req.nextUrl;

  // 관리자 페이지
  if (pathname.startsWith('/admin')) {
    if (!req.auth) {
      return Response.redirect(new URL('/login', req.nextUrl));
    }

    // 관리자 권한 확인 (세션에 role이 있다고 가정)
    if (req.auth.user?.role !== 'admin') {
      return Response.redirect(new URL('/unauthorized', req.nextUrl));
    }
  }
});
```

## 로그인 후 원래 페이지로 돌아가기

```typescript
// middleware.ts
import { auth } from '@/auth';

export default auth((req) => {
  if (!req.auth && req.nextUrl.pathname !== '/login') {
    const loginUrl = new URL('/login', req.nextUrl);
    // 원래 가려던 URL을 쿼리 파라미터로 저장
    loginUrl.searchParams.set('callbackUrl', req.nextUrl.pathname);
    return Response.redirect(loginUrl);
  }
});
```

로그인 페이지에서 `callbackUrl`로 리다이렉트:

```tsx
// app/login/page.tsx
import { signIn } from '@/auth';

export default function LoginPage({
  searchParams,
}: {
  searchParams: { callbackUrl?: string };
}) {
  const callbackUrl = searchParams.callbackUrl || '/';

  return (
    <Button.Kakao
      onClick={() => signIn('kakao', { redirectTo: callbackUrl })}
    />
  );
}
```

## API 라우트 보호

API 라우트는 미들웨어 대신 직접 세션을 확인합니다:

```typescript
// app/api/protected/route.ts
import { auth } from '@/auth';
import { NextResponse } from 'next/server';

export async function GET() {
  const session = await auth();

  if (!session) {
    return NextResponse.json(
      { error: '로그인이 필요합니다' },
      { status: 401 }
    );
  }

  return NextResponse.json({ data: 'protected data' });
}
```

## Matcher 패턴

```typescript
export const config = {
  matcher: [
    // 모든 경로 (정적 파일 제외)
    '/((?!api|_next/static|_next/image|favicon.ico).*)',

    // 특정 경로만
    '/dashboard/:path*',
    '/settings/:path*',

    // API 라우트 포함
    '/api/protected/:path*',
  ],
};
```

> 미들웨어는 Edge Runtime에서 실행됩니다. 데이터베이스 직접 연결 등 일부 기능이 제한될 수 있습니다.

---

# NextAuth 설정

K-Auth는 next-auth를 래핑합니다. `nextAuthConfig` 옵션으로 next-auth의 모든 기능을 사용할 수 있습니다.

## 기본 구조

```typescript
import { KAuth } from '@relkimm/k-auth';

export const { handlers, auth, signIn, signOut } = KAuth({
  kakao: { ... },
  naver: { ... },
  nextAuthConfig: {
    // next-auth 설정
  },
});
```

## 다른 Provider 추가

구글, 애플 등 next-auth 공식 provider를 함께 사용할 수 있습니다.

```typescript
import Google from 'next-auth/providers/google';
import Apple from 'next-auth/providers/apple';
import GitHub from 'next-auth/providers/github';

KAuth({
  kakao: { ... },
  naver: { ... },
  nextAuthConfig: {
    providers: [
      Google({
        clientId: process.env.GOOGLE_CLIENT_ID!,
        clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      }),
      Apple({
        clientId: process.env.APPLE_CLIENT_ID!,
        clientSecret: process.env.APPLE_CLIENT_SECRET!,
      }),
      GitHub({
        clientId: process.env.GITHUB_CLIENT_ID!,
        clientSecret: process.env.GITHUB_CLIENT_SECRET!,
      }),
    ],
  },
});
```

## Callbacks

세션, JWT 등을 커스터마이징할 수 있습니다.

```typescript
KAuth({
  kakao: { ... },
  nextAuthConfig: {
    callbacks: {
      // JWT 토큰에 추가 정보 저장
      jwt({ token, user, account }) {
        if (account) {
          token.provider = account.provider;
        }
        return token;
      },

      // 세션에 추가 정보 포함
      session({ session, token }) {
        if (token.sub) {
          session.user.id = token.sub;
        }
        return session;
      },

      // 로그인 허용 여부 결정
      signIn({ user, account }) {
        // 특정 조건에서만 로그인 허용
        return true;
      },
    },
  },
});
```

## 커스텀 페이지

```typescript
KAuth({
  kakao: { ... },
  nextAuthConfig: {
    pages: {
      signIn: '/login',        // 로그인 페이지
      signOut: '/logout',      // 로그아웃 페이지
      error: '/auth/error',    // 에러 페이지
      newUser: '/welcome',     // 신규 가입 시 리다이렉트
    },
  },
});
```

## 데이터베이스 연동

Prisma, Drizzle 등의 adapter를 사용할 수 있습니다.

```typescript
import { PrismaAdapter } from '@auth/prisma-adapter';
import { prisma } from '@/lib/prisma';

KAuth({
  kakao: { ... },
  nextAuthConfig: {
    adapter: PrismaAdapter(prisma),
  },
});
```

> Adapter 설정에 대한 자세한 내용은 [Auth.js Adapters 문서](https://authjs.dev/getting-started/adapters)를 참고하세요.

## 이벤트

```typescript
KAuth({
  kakao: { ... },
  nextAuthConfig: {
    events: {
      signIn({ user, account }) {
        console.log(`${user.name}님이 ${account?.provider}로 로그인했습니다.`);
      },
      signOut({ token }) {
        console.log('로그아웃');
      },
    },
  },
});
```

## 전체 예시

```typescript
import { KAuth } from '@relkimm/k-auth';
import Google from 'next-auth/providers/google';
import { PrismaAdapter } from '@auth/prisma-adapter';
import { prisma } from '@/lib/prisma';

export const { handlers, auth, signIn, signOut } = KAuth({
  kakao: {
    clientId: process.env.KAKAO_CLIENT_ID!,
    clientSecret: process.env.KAKAO_CLIENT_SECRET!,
    collectPhone: true,
  },
  naver: {
    clientId: process.env.NAVER_CLIENT_ID!,
    clientSecret: process.env.NAVER_CLIENT_SECRET!,
  },
  nextAuthConfig: {
    adapter: PrismaAdapter(prisma),
    providers: [
      Google({
        clientId: process.env.GOOGLE_CLIENT_ID!,
        clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      }),
    ],
    callbacks: {
      session({ session, token }) {
        session.user.id = token.sub!;
        return session;
      },
    },
    pages: {
      signIn: '/login',
    },
  },
});
```

---

# 에러 처리

K-Auth는 한국어로 된 친절한 에러 메시지를 제공합니다.

## 에러 형식

```
==================================================
[K-Auth 오류] KAKAO_PHONE_NOT_ENABLED
==================================================

메시지: 전화번호 동의 항목이 비활성화되어 있습니다.
힌트: 카카오 개발자센터 > 동의항목 > 전화번호를 활성화해주세요.
문서: https://developers.kakao.com/console

==================================================
```

## 주요 에러 코드

### 설정 에러

| 코드 | 설명 |
|------|------|
| `MISSING_CLIENT_ID` | clientId가 누락됨 |
| `MISSING_CLIENT_SECRET` | clientSecret이 누락됨 |
| `NO_PROVIDER_CONFIGURED` | provider가 하나도 설정되지 않음 |

### 카카오 에러

| 코드 | 설명 |
|------|------|
| `KAKAO_PHONE_NOT_ENABLED` | 전화번호 동의 항목 비활성화 |
| `KAKAO_INVALID_REDIRECT_URI` | Redirect URI 불일치 |

### 네이버 에러

| 코드 | 설명 |
|------|------|
| `NAVER_PHONE_NOT_ENABLED` | 전화번호 동의 항목 비활성화 |
| `NAVER_INVALID_CALLBACK_URL` | Callback URL 불일치 |

## 프로그래밍 방식 처리

```typescript
import { KAuthError } from '@relkimm/k-auth';

try {
  // ...
} catch (error) {
  if (error instanceof KAuthError) {
    console.log(error.code);    // 'KAKAO_PHONE_NOT_ENABLED'
    console.log(error.message); // '전화번호 동의 항목이...'
    console.log(error.hint);    // '카카오 개발자센터 > ...'
    console.log(error.docs);    // 'https://...'
  }
}
```

---

# 문제 해결

자주 발생하는 문제와 해결 방법입니다.

## 설정 관련

### AUTH_SECRET이 설정되지 않았습니다

```
[next-auth] ERROR: `AUTH_SECRET` is missing
```

`.env.local`에 `AUTH_SECRET`을 추가하세요:

```bash
openssl rand -base64 32
```

생성된 값을 환경 변수에 추가:

```env
AUTH_SECRET=생성된_값
```

### clientId 또는 clientSecret이 없습니다

```
[K-Auth 오류] MISSING_CLIENT_ID
```

환경 변수가 제대로 설정되어 있는지 확인하세요:

```env
KAKAO_CLIENT_ID=your_kakao_rest_api_key
KAKAO_CLIENT_SECRET=your_kakao_client_secret
```

`.env.local` 파일이 `.gitignore`에 포함되어 있는지도 확인하세요.

## 카카오 관련

### Redirect URI가 등록되지 않았습니다

```
KOE006: Redirect URI가 등록되지 않았습니다
```

1. [Kakao Developers](https://developers.kakao.com) 접속
2. **카카오 로그인** → **Redirect URI**
3. URI 추가: `http://localhost:3000/api/auth/callback/kakao`

> 개발용과 배포용 URI를 모두 등록해야 합니다.

### 동의 항목이 비활성화되어 있습니다

```
[K-Auth 오류] KAKAO_PHONE_NOT_ENABLED
```

1. [Kakao Developers](https://developers.kakao.com) 접속
2. **동의항목** 메뉴
3. 필요한 항목(전화번호 등) 활성화
4. **동의 단계**를 `필수 동의` 또는 `선택 동의`로 설정

### Client Secret이 활성화되지 않았습니다

1. [Kakao Developers](https://developers.kakao.com) 접속
2. **보안** 메뉴
3. **활성화 상태**를 `사용함`으로 변경

## 네이버 관련

### Callback URL이 일치하지 않습니다

1. [NAVER Developers](https://developers.naver.com) 접속
2. **API 설정** 탭
3. **Callback URL**에 `http://localhost:3000/api/auth/callback/naver` 추가

### 서비스 URL 오류

네이버는 서비스 URL 검증이 엄격합니다:
- 개발: `http://localhost:3000`
- 배포: `https://yourdomain.com` (프로토콜 포함)

## 배포 관련

### 배포 후 로그인이 안 됩니다

체크리스트:

1. **환경 변수 확인**
   - `AUTH_SECRET` 설정됨
   - `KAKAO_CLIENT_ID`, `KAKAO_CLIENT_SECRET` 등 설정됨

2. **Redirect URI 등록**
   - 카카오: `https://yourdomain.com/api/auth/callback/kakao`
   - 네이버: `https://yourdomain.com/api/auth/callback/naver`

3. **네이버 서비스 URL**
   - `https://yourdomain.com`으로 변경

4. **HTTPS 확인**
   - 배포 환경에서는 HTTPS 필수

### Vercel 배포 시 환경 변수

Vercel Dashboard에서 환경 변수를 설정하세요:
1. Project Settings → Environment Variables
2. 필요한 변수 모두 추가

## 버튼 관련

### 버튼 스타일이 적용되지 않습니다

K-Auth 버튼은 inline styles를 사용합니다. CSS 우선순위 문제가 있다면 `!important`를 사용하세요:

```tsx
<Button.Kakao className="!w-full" />
```

### 다크 모드에서 버튼이 이상합니다

버튼은 각 서비스 가이드라인에 따라 고정 색상을 사용합니다. 다크 모드에서도 동일한 색상으로 표시됩니다.

## 그 외

### 세션이 유지되지 않습니다

1. `AUTH_SECRET`이 배포 환경에서 설정되어 있는지 확인
2. 쿠키 설정 확인 (HTTPS에서는 secure 쿠키 필요)

### TypeScript 타입 에러

타입 확장이 필요하면 `types/next-auth.d.ts` 파일을 생성하세요:

```typescript
import 'next-auth';

declare module 'next-auth' {
  interface Session {
    user: {
      id: string;
      // 추가 필드
    } & DefaultSession['user'];
  }
}
```

---

# FAQ

자주 묻는 질문들입니다.

## 일반

### K-Auth와 next-auth의 차이점은?

K-Auth는 next-auth를 래핑한 라이브러리입니다. next-auth의 모든 기능을 사용하면서 카카오/네이버 로그인을 더 쉽게 구현할 수 있습니다.

| 기능 | next-auth | K-Auth |
|------|-----------|--------|
| 카카오/네이버 provider | 직접 구현 필요 | 내장 |
| 로그인 버튼 | 직접 구현 필요 | 제공 |
| 에러 메시지 | 영어 | 한국어 |
| scope 설정 | 직접 입력 | `collectPhone: true` |

### next-auth를 따로 설치해야 하나요?

아니요. K-Auth를 설치하면 next-auth가 자동으로 함께 설치됩니다.

### 구글, GitHub 등 다른 로그인도 쓸 수 있나요?

네. `nextAuthConfig`에 next-auth provider를 추가하면 됩니다.

```typescript
import Google from 'next-auth/providers/google';

KAuth({
  kakao: { ... },
  nextAuthConfig: {
    providers: [Google({ ... })],
  },
});
```

### TypeScript를 꼭 써야 하나요?

아니요. JavaScript에서도 사용할 수 있습니다. 다만 TypeScript를 사용하면 자동완성과 타입 체크의 도움을 받을 수 있습니다.

## 버튼

### Tailwind CSS가 필요한가요?

기본 버튼 스타일은 Tailwind 없이도 동작합니다. `className` prop으로 커스텀하려면 Tailwind가 필요합니다.

### 버튼 색상을 바꿀 수 있나요?

각 서비스의 디자인 가이드라인을 준수하기 위해 기본 색상 변경은 지원하지 않습니다. `className`으로 크기, 모서리, 그림자 등은 조절할 수 있습니다.

### 버튼 텍스트를 변경할 수 있나요?

현재는 지원하지 않습니다. 각 서비스 가이드라인에서 권장하는 텍스트를 사용합니다.

## 에러

### "Redirect URI가 등록되지 않았습니다" 에러

개발자 콘솔에서 Redirect URI를 등록해야 합니다:
- 카카오: `http://localhost:3000/api/auth/callback/kakao`
- 네이버: `http://localhost:3000/api/auth/callback/naver`

### "동의 항목이 비활성화되어 있습니다" 에러

`collectPhone: true` 등의 옵션을 사용하려면 개발자 콘솔에서 해당 동의 항목을 먼저 활성화해야 합니다.

### 배포 후 로그인이 안 됩니다

1. `AUTH_SECRET` 환경 변수가 설정되어 있는지 확인
2. 개발자 콘솔에서 배포 도메인의 Redirect URI 등록 확인
3. 네이버: 서비스 URL도 배포 도메인으로 변경 필요

## 데이터베이스

### 세션을 데이터베이스에 저장할 수 있나요?

네. next-auth adapter를 사용하면 됩니다.

```typescript
import { PrismaAdapter } from '@auth/prisma-adapter';

KAuth({
  kakao: { ... },
  nextAuthConfig: {
    adapter: PrismaAdapter(prisma),
  },
});
```

### 어떤 데이터베이스를 지원하나요?

next-auth가 지원하는 모든 adapter를 사용할 수 있습니다:
- Prisma
- Drizzle
- MongoDB
- Supabase
- 등 25개 이상

[Auth.js Adapters 문서](https://authjs.dev/getting-started/adapters) 참고

---

# 예제

## 기본 로그인 페이지

```tsx
// app/login/page.tsx
import { Button } from '@relkimm/k-auth/ui';
import { signIn } from '@/auth';

export default function LoginPage() {
  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="w-full max-w-sm p-8">
        <h1 className="text-2xl font-bold text-center mb-8">로그인</h1>

        <Button.Group>
          <Button.Kakao onClick={() => signIn('kakao')} />
          <Button.Naver onClick={() => signIn('naver')} />
        </Button.Group>
      </div>
    </div>
  );
}
```

## 아이콘만 있는 버튼

```tsx
<Button.Group direction="row">
  <Button.Kakao size="icon" onClick={() => signIn('kakao')} />
  <Button.Naver size="icon" onClick={() => signIn('naver')} />
  <Button.Google size="icon" onClick={() => signIn('google')} />
  <Button.Apple size="icon" onClick={() => signIn('apple')} />
</Button.Group>
```

## 세션 확인

```tsx
// app/page.tsx
import { auth } from '@/auth';

export default async function Home() {
  const session = await auth();

  if (!session) {
    return <a href="/login">로그인하세요</a>;
  }

  return (
    <div>
      <p>안녕하세요, {session.user?.name}님!</p>
      <img src={session.user?.image} alt="프로필" />
    </div>
  );
}
```

## 로그아웃

```tsx
import { signOut } from '@/auth';

<button onClick={() => signOut()}>로그아웃</button>
```

## 미들웨어로 보호

```typescript
// middleware.ts
import { auth } from '@/auth';

export default auth((req) => {
  if (!req.auth && req.nextUrl.pathname !== '/login') {
    const newUrl = new URL('/login', req.nextUrl.origin);
    return Response.redirect(newUrl);
  }
});

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
};
```

## 전체 설정 예시

```typescript
// auth.ts
import { KAuth } from '@relkimm/k-auth';
import Google from 'next-auth/providers/google';

export const { handlers, auth, signIn, signOut } = KAuth({
  kakao: {
    clientId: process.env.KAKAO_CLIENT_ID!,
    clientSecret: process.env.KAKAO_CLIENT_SECRET!,
    collectPhone: true,
    collectBirth: true,
  },
  naver: {
    clientId: process.env.NAVER_CLIENT_ID!,
    clientSecret: process.env.NAVER_CLIENT_SECRET!,
    collectName: true,
  },
  nextAuthConfig: {
    providers: [
      Google({
        clientId: process.env.GOOGLE_CLIENT_ID!,
        clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      }),
    ],
    callbacks: {
      session({ session, token }) {
        if (token.sub) {
          session.user.id = token.sub;
        }
        return session;
      },
    },
    pages: {
      signIn: '/login',
    },
  },
});
```
